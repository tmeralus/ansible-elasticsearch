---
#
# Install/run logstash
#

- name: Copy logstash yum repo file
  copy:
    src: logstash.repo
    dest: /etc/yum.repos.d/logstash.repo
    owner: root
    group: root
    mode: 0644
  become: true

- name: Install logstash rpms
  yum:
    name: logstash
    state: present 
  become: true

- name: Copy logstash filter configuration
  template:
    src: logstash.conf.j2
    dest: /etc/logstash/conf.d/logstash.conf
    owner: logstash
    group: logstash
    mode: 0644
  become: true

- name: Load OpenSSL CA Extended Configuration
  template:
    src: openssl_extras.cnf.j2
    dest: /etc/pki/tls/openssl_extras.cnf
    owner: root
    group: root
    mode: 0644
  become: true

- name: Check OpenSSL SANs (SubjectAltName) entry for CA
  shell: grep "{{ ansible_default_ipv4.address }}" /etc/pki/tls/openssl.cnf | wc -l
  ignore_errors: true
  register: subjectAltName_exists
  tags:
    # Skip ANSIBLE0012 Commands should not change things if nothing needs doing
    # Need to understand if an entry exists
    - skip_ansible_lint
  become: true

- name: Add OpenSSL SANs (SubjectAltName) entry for CA
  lineinfile:
    dest: /etc/pki/tls/openssl.cnf
    line: 'subjectAltName = "IP: {{ ansible_default_ipv4.address }}"'
    regexp: '^ Extensions for a typical CA'
    insertbefore: '# Extensions for a typical CA'
    backup: yes
  when: subjectAltName_exists.stdout|int == 0
  become: true

- name: Start or restart logstash service
  command: systemctl restart logstash.service
  ignore_errors: true
  become: true

- name: Setup logstash service to autostart
  service:
    name: logstash
    state: started
    enabled: true
  become: true
